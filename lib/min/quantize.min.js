if(!pv)var pv={map:function(r,o){var n={};return o?r.map(function(r,t){return n.index=t,o.call(n,r)}):r.slice()},naturalOrder:function(r,o){return o>r?-1:r>o?1:0},sum:function(r,o){var n={};return r.reduce(o?function(r,t,e){return n.index=e,r+o.call(n,t)}:function(r,o){return r+o},0)},max:function(r,o){return Math.max.apply(null,o?pv.map(r,o):r)}};var MMCQ=function(){function r(r,o,n){return(r<<2*f)+(o<<f)+n}function o(r){function o(){n.sort(r),t=!0}var n=[],t=!1;return{push:function(r){n.push(r),t=!1},peek:function(r){return t||o(),void 0===r&&(r=n.length-1),n[r]},pop:function(){return t||o(),n.pop()},size:function(){return n.length},map:function(r){return n.map(r)},debug:function(){return t||o(),n}}}function n(r,o,n,t,e,u,i){var c=this;c.r1=r,c.r2=o,c.g1=n,c.g2=t,c.b1=e,c.b2=u,c.histo=i}function t(){this.vboxes=new o(function(r,o){return pv.naturalOrder(r.vbox.count()*r.vbox.volume(),o.vbox.count()*o.vbox.volume())})}function e(o){var n,t,e,u,i=1<<3*f,c=new Array(i);return o.forEach(function(o){t=o[0]>>a,e=o[1]>>a,u=o[2]>>a,n=r(t,e,u),c[n]=(c[n]||0)+1}),c}function u(r,o){var t,e,u,i=1e6,c=0,f=1e6,v=0,s=1e6,p=0;return r.forEach(function(r){t=r[0]>>a,e=r[1]>>a,u=r[2]>>a,i>t?i=t:t>c&&(c=t),f>e?f=e:e>v&&(v=e),s>u?s=u:u>p&&(p=u)}),new n(i,c,f,v,s,p,o)}function i(o,n){function t(r){var o,t,e,u,i,c=r+"1",a=r+"2",v=0;for(f=n[c];f<=n[a];f++)if(h[f]>l/2){for(e=n.copy(),u=n.copy(),o=f-n[c],t=n[a]-f,i=t>=o?Math.min(n[a]-1,~~(f+t/2)):Math.max(n[c],~~(f-1-o/2));!h[i];)i++;for(v=b[i];!v&&h[i-1];)v=b[--i];return e[a]=i,u[c]=e[a]+1,console.log("vbox counts:",n.count(),e.count(),u.count()),[e,u]}}if(n.count()){var e=n.r2-n.r1+1,u=n.g2-n.g1+1,i=n.b2-n.b1+1,c=pv.max([e,u,i]);if(1==n.count())return[n.copy()];var f,a,v,s,p,l=0,h=[],b=[];if(c==e)for(f=n.r1;f<=n.r2;f++){for(s=0,a=n.g1;a<=n.g2;a++)for(v=n.b1;v<=n.b2;v++)p=r(f,a,v),s+=o[p]||0;l+=s,h[f]=l}else if(c==u)for(f=n.g1;f<=n.g2;f++){for(s=0,a=n.r1;a<=n.r2;a++)for(v=n.b1;v<=n.b2;v++)p=r(a,f,v),s+=o[p]||0;l+=s,h[f]=l}else for(f=n.b1;f<=n.b2;f++){for(s=0,a=n.r1;a<=n.r2;a++)for(v=n.g1;v<=n.g2;v++)p=r(a,v,f),s+=o[p]||0;l+=s,h[f]=l}return h.forEach(function(r,o){b[o]=l-r}),c==e?t("r"):c==u?t("g"):t("b")}}function c(r,n){function c(r,o){for(var n,t=1,e=0;v>e;)if(n=r.pop(),n.count()){var u=i(f,n),c=u[0],a=u[1];if(!c)return console.log("vbox1 not defined; shouldn't happen!"),void 0;if(r.push(c),a&&(r.push(a),t++),t>=o)return;if(e++>v)return console.log("infinite loop; perhaps too few pixels!"),void 0}else r.push(n),e++}if(!r.length||2>n||n>256)return console.log("wrong number of maxcolors"),!1;var f=e(r),a=0;f.forEach(function(){a++});var p=u(r,f),l=new o(function(r,o){return pv.naturalOrder(r.count(),o.count())});l.push(p),c(l,s*n);for(var h=new o(function(r,o){return pv.naturalOrder(r.count()*r.volume(),o.count()*o.volume())});l.size();)h.push(l.pop());c(h,n-h.size());for(var b=new t;h.size();)b.push(h.pop());return b}var f=5,a=8-f,v=1e3,s=.75;return n.prototype={volume:function(r){var o=this;return(!o._volume||r)&&(o._volume=(o.r2-o.r1+1)*(o.g2-o.g1+1)*(o.b2-o.b1+1)),o._volume},count:function(o){var n=this,t=n.histo;if(!n._count_set||o){var e,u,i,c=0;for(e=n.r1;e<=n.r2;e++)for(u=n.g1;u<=n.g2;u++)for(i=n.b1;i<=n.b2;i++)index=r(e,u,i),c+=t[index]||0;n._count=c,n._count_set=!0}return n._count},copy:function(){var r=this;return new n(r.r1,r.r2,r.g1,r.g2,r.b1,r.b2,r.histo)},avg:function(o){var n=this,t=n.histo;if(!n._avg||o){var e,u,i,c,a,v=0,s=1<<8-f,p=0,l=0,h=0;for(u=n.r1;u<=n.r2;u++)for(i=n.g1;i<=n.g2;i++)for(c=n.b1;c<=n.b2;c++)a=r(u,i,c),e=t[a]||0,v+=e,p+=e*(u+.5)*s,l+=e*(i+.5)*s,h+=e*(c+.5)*s;v?n._avg=[~~(p/v),~~(l/v),~~(h/v)]:(console.log("empty box"),n._avg=[~~(s*(n.r1+n.r2+1)/2),~~(s*(n.g1+n.g2+1)/2),~~(s*(n.b1+n.b2+1)/2)])}return n._avg},contains:function(r){var o=this,n=r[0]>>a;return gval=r[1]>>a,bval=r[2]>>a,n>=o.r1&&n<=o.r2&&gval>=o.g1&&n<=o.g2&&bval>=o.b1&&n<=o.b2}},t.prototype={push:function(r){this.vboxes.push({vbox:r,color:r.avg()})},palette:function(){return this.vboxes.map(function(r){return r.color})},size:function(){return this.vboxes.size()},map:function(r){for(var o=this.vboxes,n=0;n<o.size();n++)if(o.peek(n).vbox.contains(r))return o.peek(n).color;return this.nearest(r)},nearest:function(r){for(var o,n,t,e=this.vboxes,u=0;u<e.size();u++)n=Math.sqrt(Math.pow(r[0]-e.peek(u).color[0],2)+Math.pow(r[1]-e.peek(u).color[1],2)+Math.pow(r[1]-e.peek(u).color[1],2)),(o>n||void 0===o)&&(o=n,t=e.peek(u).color);return t},forcebw:function(){var r=this.vboxes;r.sort(function(r,o){return pv.naturalOrder(pv.sum(r.color),pv.sum(o.color))});var o=r[0].color;o[0]<5&&o[1]<5&&o[2]<5&&(r[0].color=[0,0,0]);var n=r.length-1,t=r[n].color;t[0]>251&&t[1]>251&&t[2]>251&&(r[n].color=[255,255,255])}},{quantize:c}}();