Parse.Cloud.define("sendEmailInvite",function(e,r){var o=require("sendgrid");o.initialize("alecm00re","$occerStats123");var s,a,t=e.params.coachName,n=e.params.teamId,i=e.params.teamName,c=e.params.emailTo,l=e.params.tempPassword,u=new Parse.Query("User");u.equalTo("email",c),u.find({success:function(e){if(e.length<=0){a="<p style='font-family:sans-serif;'>Hi There! <br/><br/>You have been invited to Premier Stats by <i>"+t+"</i> with the team <b>"+i+"</b>! <br/><br/>To login, go to <a href='http://alecmmoore.github.io#/login?teamid="+n+"'>http://alecmmoore.github.io#/login?teamid="+n+"</a> and use your email and temporary password to log in. You can change your password once you have already logged in.<br/><br/><br/><br/>Email: <b>"+c+"</b> <br/><br/>Temporary Password: <b>"+l+"</b><br/> <br/><br/><br/><br/>Please logon and register your player.<br/><br/>Thanks!<br/>Premier Stats Development Team</p>";var u=Parse.Object.extend("Team"),m=new Parse.Query(u);m.equalTo("objectId",n),m.find({success:function(e){console.log(e);var t=new Parse.User;t.set("username",c),t.set("password",l),t.set("email",c),t.addUnique("teams",e[0]),t.set("accountType",2),t.signUp(null,{success:function(){s=o.Email({to:c}),s.setFrom("no-reply@soccerstats.com"),s.setFromName("Premier Stats"),s.setSubject("Welcome to Premier Stats!"),s.setHTML(a),o.sendEmail(s).then(function(e){console.log(e),r.success("Email sent!")},function(e){console.error(e),r.error(e)})},error:function(e,r){console.log("Error: "+r.code+" "+r.message)}})},error:function(e){console.log("Error: "+e.code+" "+e.message)}})}else{a="<p style='font-family:sans-serif;'>Hi There! <br/><br/>You have been invited to Premier Stats by <i>"+t+"</i> with the team <b>"+i+"</b>! <br/><br/>Looks like you already have an account with us, so go ahead and log in at http://alecmmoore.github.io#/login to accept the invitation.<br/><br/><br/><br/>Please logon and register your player.Thanks!<br/>Premier Stats Development Team</p>";var u=Parse.Object.extend("Team"),m=new Parse.Query(u);m.equalTo("objectId",n),m.find({success:function(t){Parse.Cloud.useMasterKey(),e[0].addUnique("teams",t[0]),e[0].save(null,{success:function(){s=o.Email({to:c}),s.setFrom("no-reply@soccerstats.com"),s.setFromName("Premier Stats"),s.setSubject("Welcome to Premier Stats!"),s.setHTML(a),o.sendEmail(s).then(function(e){console.log(e),r.success("Email sent!")},function(e){console.error(e),r.error(e)})},error:function(e,o){r.error(o)}})},error:function(e,r){console.log("Error: "+r.code+" "+r.message)}})}},error:function(){r.error("User lookup failed")}})}),Parse.Cloud.define("addPlayer",function(e,r){var o=e.params.newPlayerId,s=e.params.parentId,a=Parse.Object.extend("Players"),t=new Parse.Query(a);t.equalTo("objectId",o),t.first({success:function(e){var o=Parse.Object.extend("_User"),a=new Parse.Query(o);a.equalTo("objectId",s),a.first({success:function(o){Parse.Cloud.useMasterKey(),o.addUnique("players",e),o.save(null,{success:function(){r.success("player added")},error:function(e,o){r.error(o)}})},error:function(e,o){r.error(o)}})},error:function(e,o){r.error(o)}})}),Parse.Cloud.define("removePlayer",function(e,r){var o=e.params.playerId,s=Parse.Object.extend("_User"),a=require("underscore.js"),t=new Parse.Query(s);t.equalTo("players",{__type:"Pointer",className:"Players",objectId:o}),t.equalTo("accountType",2),t.find({success:function(e){Parse.Cloud.useMasterKey(),a.each(e,function(e){var r=a.find(e.get("players"),function(e){return e.id==o});e.remove("players",r),e.save()}),r.success("players removed from parents")},error:function(e){r.error(e)}})});